<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Parking Ociopia - Monitor LED</title>
    <style>
        body { 
            font-family: 'Segoe UI', sans-serif; 
            text-align: center; background-color: #1a1a1a; color: white; margin: 0; padding: 20px;
        }

        .map-container {
            position: relative; display: inline-block; margin: 20px auto;
            border: 4px solid #444; border-radius: 12px; background-color: white; line-height: 0;
        }

        .map-image { display: block; max-width: 95vw; max-height: 75vh; border-radius: 8px; }

        /* ZONAS CON COORDENADAS DE TU ÚLTIMA CAPTURA */
        .zona-interactiva {
            position: absolute; cursor: pointer; transition: all 0.3s;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-weight: bold; border-radius: 8px; overflow: hidden;
        }
        .zona-interactiva:hover { background-color: rgba(0, 0, 0, 0.7); }

        #zona-norte { border: 3px solid #3498db; color: #3498db; }
        #zona-sur { border: 3px solid #e74c3c; color: #e74c3c; }
        #zona-central { border: 3px solid #f39c12; color: #f39c12; }

        .texto-zona { font-size: 14px; margin-bottom: 2px; text-transform: uppercase; color: white; }
        .info-rapida { font-size: 10px; color: #ccc; margin-bottom: 5px; }

        .contenedor-leds { display: flex; gap: 12px; }
        .led-item { display: flex; flex-direction: column; align-items: center; font-size: 9px; color: white; }
        .led {
            width: 20px; height: 20px; border-radius: 4px; border: 2px solid white;
            margin-bottom: 2px; transition: all 0.3s;
        }
        .led-adaptada { border-radius: 50%; }

        .led-off { background-color: #2ecc71; box-shadow: 0 0 10px #2ecc71; }
        .led-on { background-color: #e74c3c; box-shadow: 0 0 10px #e74c3c; }
        .led-error { background-color: #95a5a6; } 

        #info-panel {
            max-width: 450px; margin: 20px auto; padding: 20px;
            background: #ffffff; color: #333; border-radius: 10px;
            display: none; border-top: 8px solid #333;
        }
    </style>
</head>
<body>

    <h1>Parking Ociopia - Monitorización</h1>

    <div class="map-container">
        <img src="{{ url_for('static', filename='img/logo_parking.png') }}" class="map-image">

        <div id="zona-norte" class="zona-interactiva" style="top: 3%; left: 79%; width: 20%; height: 30%;" onclick="mostrarInfo('Zona Norte')">
            <div class="texto-zona">Norte</div>
            <div class="info-rapida">Total: 45 | PMR: 4</div>
            <div class="contenedor-leds">
                <div class="led-item"><div id="led-p2" class="led led-adaptada led-error"></div>PMR</div>
                <div class="led-item"><div id="led-p3" class="led led-error"></div>STD</div>
            </div>
        </div>
        
        <div id="zona-sur" class="zona-interactiva" style="top: 40%; left: 79%; width: 20%; height: 20%;" onclick="mostrarInfo('Zona Sur')">
            <div class="texto-zona">Sur</div>
            <div class="info-rapida">Total: 29 | PMR: 2</div>
            <div class="contenedor-leds">
                <div class="led-item"><div id="led-p4" class="led led-adaptada led-error"></div>PMR</div>
                <div class="led-item"><div id="led-p5" class="led led-error"></div>STD</div>
            </div>
        </div>

        <div id="zona-central" class="zona-interactiva" style="top: 60%; left: 0%; width: 70%; height: 35%;" onclick="mostrarInfo('Zona Central')">
            <div class="texto-zona">Central</div>
            <div class="info-rapida">Total: 198 | PMR: 9</div>
            <div class="contenedor-leds">
                <div class="led-item"><div id="led-p6" class="led led-adaptada led-error"></div>PMR</div>
                <div class="led-item"><div id="led-p7" class="led led-error"></div>STD</div>
            </div>
        </div>
    </div>

    <div id="info-panel">
        <h2 id="zona-nombre">Sector</h2>
        <div id="zona-stats"></div>
        <button onclick="document.getElementById('info-panel').style.display='none'" style="margin-top:15px; cursor:pointer; padding:10px; width:100%;">CERRAR</button>
    </div>

    <script>
        const CONFIG = {
            "Zona Norte":   { normales: 41, adaptadas: 4, color: "#3498db" },
            "Zona Sur":     { normales: 27, adaptadas: 2, color: "#e74c3c" },
            "Zona Central": { normales: 189, adaptadas: 9, color: "#f39c12" }
        };

        let estadosPines = {};

        function mostrarInfo(nombreZona) {
            let nOcupadas = 0; let aOcupadas = 0;
            if(nombreZona === "Zona Norte") { aOcupadas = estadosPines.p2 === 1 ? 1 : 0; nOcupadas = estadosPines.p3 === 1 ? 1 : 0; }
            else if(nombreZona === "Zona Sur") { aOcupadas = estadosPines.p4 === 1 ? 1 : 0; nOcupadas = estadosPines.p5 === 1 ? 1 : 0; }
            else { aOcupadas = estadosPines.p6 === 1 ? 1 : 0; nOcupadas = estadosPines.p7 === 1 ? 1 : 0; }

            const panel = document.getElementById('info-panel');
            panel.style.display = 'block';
            panel.style.borderTopColor = CONFIG[nombreZona].color;
            document.getElementById('zona-nombre').innerText = nombreZona;
            document.getElementById('zona-stats').innerHTML = `
                <p><b>Plazas Estándar:</b> ${CONFIG[nombreZona].normales - nOcupadas} libres de ${CONFIG[nombreZona].normales}</p>
                <p><b>Plazas PMR (♿):</b> ${CONFIG[nombreZona].adaptadas - aOcupadas} libres de ${CONFIG[nombreZona].adaptadas}</p>
            `;
        }

        function actualizar() {
            fetch('/status').then(res => res.json()).then(data => {
                estadosPines = data;
                for (let i = 2; i <= 7; i++) {
                    const led = document.getElementById('led-p' + i);
                    if (!led) continue;
                    led.className = 'led ' + (led.classList.contains('led-adaptada') ? 'led-adaptada ' : '') + 
                        (data['p' + i] === 1 ? 'led-on' : (data['p' + i] === 0 ? 'led-off' : 'led-error'));
                }
            });
        }
        setInterval(actualizar, 2000);
        actualizar();
    </script>
</body>
</html>
