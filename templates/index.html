<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Parking Ociopia - Zonas Interactivas</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            text-align: center; 
            background-color: #1a1a1a; 
            color: white; margin: 0; padding: 20px;
        }

        .map-container {
            position: relative;
            display: inline-block;
            margin: 20px auto;
            border: 4px solid #3498db;
            border-radius: 12px;
            background-color: white;
            line-height: 0;
        }

        .map-image {
            display: block;
            max-width: 95vw;
            max-height: 75vh;
            border-radius: 8px;
        }

        /* ESTILO DE LAS ÁREAS DELIMITADAS */
        .zona-interactiva {
            position: absolute;
            cursor: pointer;
            border: 3px dashed rgba(255,255,255,0.5);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            text-shadow: 1px 1px 4px rgba(0,0,0,0.8);
        }

        .zona-interactiva:hover {
            border-style: solid;
            background-color: rgba(52, 152, 219, 0.2);
        }

        /* Colores dinámicos para las zonas */
        .estado-libre { background-color: rgba(46, 204, 113, 0.3); border-color: #2ecc71; }
        .estado-alerta { background-color: rgba(231, 76, 60, 0.3); border-color: #e74c3c; }
        .estado-error { background-color: rgba(241, 196, 15, 0.3); border-color: #f1c40f; }

        #info-panel {
            max-width: 450px;
            margin: 20px auto;
            padding: 20px;
            background: #ffffff;
            color: #333;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            display: none;
            border-top: 8px solid #3498db;
        }
    </style>
</head>
<body>

    <h1>Parking Ociopia - Mapa por Sectores</h1>
    <p>Pulsa sobre cualquier área coloreada para ver la disponibilidad real.</p>

    <div class="map-container">
        <img src="{{ url_for('static', filename='img/logo_parking.png') }}" class="map-image">

        <div id="zona-norte" class="zona-interactiva estado-error" 
             style="top: 5%; left: 70%; width: 25%; height: 30%;" 
             onclick="mostrarInfo('Zona Norte')">SECTOR NORTE</div>
        
        <div id="zona-sur" class="zona-interactiva estado-error" 
             style="top: 60%; left: 55%; width: 40%; height: 35%;" 
             onclick="mostrarInfo('Zona Sur')">SECTOR SUR</div>

        <div id="zona-central" class="zona-interactiva estado-error" 
             style="top: 35%; left: 10%; width: 40%; height: 40%;" 
             onclick="mostrarInfo('Zona Central')">SECTOR CENTRAL</div>
    </div>

    <div id="info-panel">
        <h2 id="zona-nombre" style="margin:0; color:#2c3e50;">Sector</h2>
        <div id="zona-stats" style="font-size: 1.1em; line-height: 1.6; text-align: left; margin-top: 10px;"></div>
        <button onclick="document.getElementById('info-panel').style.display='none'" style="margin-top:15px; cursor:pointer; padding:10px; background:#3498db; color:white; border:none; border-radius:5px; width:100%; font-weight:bold;">CERRAR</button>
    </div>

    <script>
        const CONFIG = {
            "Zona Norte":   { normales: 43, adaptadas: 2 },
            "Zona Sur":     { normales: 27, adaptadas: 2 },
            "Zona Central": { normales: 192, adaptadas: 6 }
        };

        // Guardamos los estados de los pines para el cálculo
        let estadosPines = { p2: null, p3: null, p4: null, p5: null, p6: null, p7: null };

        function mostrarInfo(nombreZona) {
            let nOcupadas = 0;
            let aOcupadas = 0;

            if (nombreZona === "Zona Norte") {
                if(estadosPines.p2 === 1) aOcupadas++;
                if(estadosPines.p3 === 1) nOcupadas++;
            } else if (nombreZona === "Zona Sur") {
                if(estadosPines.p4 === 1) aOcupadas++;
                if(estadosPines.p5 === 1) nOcupadas++;
            } else if (nombreZona === "Zona Central") {
                if(estadosPines.p6 === 1) aOcupadas++;
                if(estadosPines.p7 === 1) nOcupadas++;
            }

            const totalN = CONFIG[nombreZona].normales;
            const totalA = CONFIG[nombreZona].adaptadas;
            
            document.getElementById('info-panel').style.display = 'block';
            document.getElementById('zona-nombre').innerText = nombreZona;
            document.getElementById('zona-stats').innerHTML = `
                <div style="border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 8px;">
                    <b>Plazas Estándar:</b><br>
                    Disponibles: <span style="color:#2ecc71; font-weight:bold">${totalN - nOcupadas}</span> de ${totalN}
                </div>
                <div>
                    <b style="color:#0056b3;">Plazas Adaptadas (♿):</b><br>
                    Disponibles: <span style="color:#3498db; font-weight:bold">${totalA - aOcupadas}</span> de ${totalA}
                </div>
            `;
        }

        function actualizarDatos() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    estadosPines = data; // Guardamos los datos nuevos
                    
                    // Actualizar colores de las áreas
                    actualizarColorZona('zona-norte', data.p2, data.p3);
                    actualizarColorZona('zona-sur', data.p4, data.p5);
                    actualizarColorZona('zona-central', data.p6, data.p7);
                });
        }

        function actualizarColorZona(idDiv, pinA, pinN) {
            const el = document.getElementById(idDiv);
            el.classList.remove('estado-libre', 'estado-alerta', 'estado-error');
            
            if (pinA === null || pinN === null) {
                el.classList.add('estado-error');
            } else if (pinA === 1 || pinN === 1) {
                el.classList.add('estado-alerta'); // Si hay alguien, se pone rojizo
            } else {
                el.classList.add('estado-libre'); // Si todo está libre, verde
            }
        }

        setInterval(actualizarDatos, 2000);
        actualizarDatos();
    </script>
</body>
</html>
